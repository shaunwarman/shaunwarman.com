<!DOCTYPE html><html data-saber-ssr><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.11.5"><meta data-saber-head="ssr" name="description" content="Heads down"><meta data-saber-head="ssr" name="description" content="
"> <title>Understanding docker images - Shaun Warman</title> <link data-saber-head="ssr" rel="alternate" title="Shaun Warman - Feed" type="application/json" href="null"><style data-vue-ssr-id="60268c6a:0">blockquote,body,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,ol,p,pre,ul{margin:0;padding:0}body{font:400 16px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;color:#111;background-color:#fdfdfd;-webkit-text-size-adjust:100%;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1;font-feature-settings:"kern" 1;font-kerning:normal;display:flex;min-height:100vh;flex-direction:column}blockquote,dl,figure,h1,h2,h3,h4,h5,h6,ol,p,pre,ul{margin-bottom:15px}main{display:block}img{max-width:100%;vertical-align:middle}figure>img{display:block}figcaption{font-size:14px}ol,ul{margin-left:30px}li>ol,li>ul{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:400}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}.social-media-list a:hover{text-decoration:none}.social-media-list a:hover .username{text-decoration:underline}blockquote{color:#828282;border-left:4px solid #e8e8e8;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}code,pre{font-size:15px;border:1px solid #e8e8e8;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:770px;margin-right:auto;margin-left:auto;padding-right:15px;padding-left:15px}@media screen and (min-width:800px){.wrapper{max-width:740px;padding-right:30px;padding-left:30px}}.footer-col-wrapper:after,.wrapper:after{content:"";display:table;clear:both}.orange{color:#f66a0a}.grey{color:#828282}.svg-icon{width:16px;height:16px;display:inline-block;fill:currentColor;padding:5px 3px 2px 5px;vertical-align:text-bottom}table{margin-bottom:30px;width:100%;text-align:left;color:#3f3f3f;border-collapse:collapse;border:1px solid #e8e8e8}table tr:nth-child(2n){background-color:#f7f7f7}table td,table th{padding:10px 15px}table th{background-color:#f0f0f0;border:1px solid #dedede;border-bottom-color:#c9c9c9}table td{border:1px solid #e8e8e8}.site-header{border-top:5px solid #424242;border-bottom:1px solid #e8e8e8;min-height:55.95px;line-height:54px;position:relative}.site-title{font-size:26px;font-weight:300;letter-spacing:-1px;margin-bottom:0;float:left}@media screen and (max-width:600px){.site-title{padding-right:45px}}.site-title,.site-title:visited{color:#424242}.site-nav{position:absolute;top:9px;right:15px;background-color:#fdfdfd;border:1px solid #e8e8e8;border-radius:5px;text-align:right}.site-nav .nav-trigger{display:none}.site-nav .menu-icon{float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg path{fill:#424242}.site-nav label[for=nav-trigger]{display:block;float:right;width:36px;height:36px;z-index:2;cursor:pointer}.site-nav input~.trigger{clear:both;display:none}.site-nav input:checked~.trigger{display:block;padding-bottom:5px}.site-nav .page-link{color:#111;line-height:1.5;display:block;padding:5px 10px;margin-left:20px}.site-nav .page-link:not(:last-child){margin-right:0}@media screen and (min-width:600px){.site-nav{position:static;float:right;border:none;background-color:inherit}.site-nav .menu-icon,.site-nav label[for=nav-trigger]{display:none}.site-nav input~.trigger{display:block}.site-nav .page-link{display:inline;padding:0;margin-left:auto}.site-nav .page-link:not(:last-child){margin-right:20px}}.pagination{margin-bottom:25px;font-size:.875rem}.pagination .next-link,.pagination .prev-link{border:1px solid #e8e8e8;padding:5px 10px;color:#111}.site-footer{border-top:1px solid #e8e8e8;padding:30px 0}.footer-heading{font-size:18px;margin-bottom:15px}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#828282;margin-left:-15px}.footer-col{width:-webkit-calc(100% - 15px);width:calc(100% - 15px);margin-bottom:15px;padding-left:15px}.footer-col-1,.footer-col-2{width:-webkit-calc(50% - 15px);width:calc(50% - 15px)}.footer-col-3{width:-webkit-calc(100% - 15px);width:calc(100% - 15px)}@media screen and (min-width:800px){.footer-col-1{width:-webkit-calc(35% - 15px);width:calc(35% - 15px)}.footer-col-2{width:-webkit-calc(20% - 15px);width:calc(20% - 15px)}.footer-col-3{width:-webkit-calc(45% - 15px);width:calc(45% - 15px)}}@media screen and (min-width:600px){.footer-col{float:left}}.page-content{padding:30px 0;flex:1 0 auto}.page-heading{font-size:32px}.post-list-heading{font-size:28px}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:30px}.post-meta{font-size:14px;color:#828282}.post-link{display:block;font-size:24px}.post-header{margin-bottom:30px}.post-content h1,.post-title{font-size:42px;letter-spacing:-1px;line-height:1}@media screen and (min-width:800px){.post-content h1,.post-title{font-size:42px}}.post-content{margin-bottom:30px}.post-content h2{font-size:28px}@media screen and (min-width:800px){.post-content h2{font-size:32px}}.post-content h3{font-size:22px}@media screen and (min-width:800px){.post-content h3{font-size:26px}}.post-content h4{font-size:18px}@media screen and (min-width:800px){.post-content h4{font-size:20px}}.social-media-list{display:table;margin:0 auto}.social-media-list li{float:left;margin:0 5px}.social-media-list li:first-of-type{margin-left:0}.social-media-list li:last-of-type{margin-right:0}.social-media-list li a{display:block;padding:7.5px;border:1px solid #e8e8e8}.social-media-list li:hover .svg-icon{fill:currentColor}.one-half{width:-webkit-calc(50% - 15px);width:calc(50% - 15px)}</style>  </head><body><div id="_saber" data-server-rendered="true"><div><header class="site-header"><div class="wrapper"><a href="/" rel="author" class="site-title router-link-active">Shaun Warman</a> <nav class="site-nav"><input type="checkbox" id="nav-trigger" class="nav-trigger"> <label for="nav-trigger"><span class="menu-icon"><svg viewBox="0 0 18 15" width="18px" height="15px"><path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path></svg></span></label> <div class="trigger"><a href="/" class="page-link router-link-active">Home</a><a href="/about.html" class="page-link">About</a></div></nav></div></header> <main aria-label="Content" class="page-content"><div class="wrapper"><article itemscope="itemscope" itemtype="http://schema.org/BlogPosting" class="post h-entry"><header class="post-header"><h1 itemprop="name headline" class="post-title p-name">Understanding docker images</h1> <p class="post-meta"><time datetime="Mon Jun 25 2018 19:00:00 GMT-0500 (Central Daylight Time)" itemprop="datePublished" class="dt-published">2018-06-25</time></p></header> <div itemprop="articleBody" class="post-content e-content"><p><img src="https://miro.medium.com/max/1400/0*Ld_q9vnfpV5ZVRFe" alt=""></p> <p>TLDR;</p> <ul><li>Minimize the amount of image layers</li> <li>Use image layer cache correctly</li> <li>Take advantage of image layers at deploy time</li> <li>Keep images as light as possible</li></ul> <h2 id="image-layers">Image layers</h2> <p>Each docker image you use to start a container is really a cohesive set of smaller image layers. When you build your images, it’s important to understand how these layers will be used at build and deploy time.</p> <h3 id="build-time">Build time</h3> <p>To build an image, you use a Dockerfile with a set of instructions of what to do to build that image. Each instruction is, essentially, an image layer. Each image layer could be copying a file or directory or a command or set of commands. Here’s a simple example.</p> <div class="saber-highlight" data-lang="sh"><pre class="saber-highlight-code language-sh"><code class="language-sh">FROM node:10.7.0-alpine

WORKDIR /usr/src/app

COPY package*.json /usr/src/app/

RUN npm install &amp;&amp; \
    npm cache clean -f

COPY . .

CMD [&quot;/bin/bash&quot;, &quot;/usr/src/app/init&quot;]</code></pre></div><p>Above is our example Dockerfile. It has a base image for nodejs that is an alpine flavor. We setup a working directory, copy files and run some commands. We also have a command that runs when a container is started from this image. Now, why would we not just copy all the files instead of splitting that into 2 copy sections? Let’s build an image from this Dockerfile and see what docker is doing.</p> <blockquote><p>$ docker build -t node:latest .</p></blockquote> <div class="saber-highlight" data-lang="sh"><pre class="saber-highlight-code language-sh"><code class="language-sh">Step 1/6 : FROM node:10.7.0-alpine
 ---&gt; 27d9cbdc7319
Step 2/6 : WORKDIR /usr/src/app
 ---&gt; Using cache
 ---&gt; b738b82730f9
Step 3/6 : COPY package*.json /usr/src/app/
 ---&gt; Using cache
 ---&gt; e50e35f227ce
Step 4/6 : RUN npm install &amp;&amp;     npm cache clean --force
 ---&gt; Using cache
 ---&gt; a9f846b4f00b
Step 5/6 : COPY . .
 ---&gt; Using cache
 ---&gt; c0abb68127bb
Step 6/6 : CMD [&quot;/bin/bash&quot;, &quot;/usr/src/app/init&quot;]
 ---&gt; Using cache
 ---&gt; 22596d178dbe
Successfully built 22596d178dbe
Successfully tagged node:latest</code></pre></div><p>Docker takes the Dockerfile instructions and the files in the directory, and runs through each command step-by-step, building an image layer for each command. If we look above at our Dockerfile, we have six instructions and accordingly in the build output we have six steps or image layers. As you can see below each step, there is a hash. This hash is based on the command or the files that are copied in. If the command or file changes, the hash changes, therefore, busting the cache. If the cache is busted at any step, then that step and any step after that will not be cached. Let’s take a look at each image layer created from this build.</p> <blockquote><p>$ docker history node:latest</p></blockquote> <div class="saber-highlight" data-lang="sh"><pre class="saber-highlight-code language-sh"><code class="language-sh">IMAGE               CREATED             CREATED BY                                      SIZE
22596d178dbe        40 hours ago        /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot; &quot;/usr/sr…   0B
c0abb68127bb        40 hours ago        /bin/sh -c #(nop) COPY dir:25fadb737f3963795…   223MB
a9f846b4f00b        40 hours ago        /bin/sh -c npm install &amp;&amp;     npm cache clea…   1.66MB
e50e35f227ce        40 hours ago        /bin/sh -c #(nop) COPY multi:a01b4a429dfd4d6…   64.3kB</code></pre></div><p>The image layers shown above are an inverse to the steps that were run as the images are built on top of each other step-by-step. For the second image down, we see a “COPY dir:25adb…”. This means the COPY instruction copied a directory and gave that directory a hash (sha256). If we were to build again and the content, and therefore hash, changed then we would not use the cache and run that instruction fresh. So, let’s loop back around and look at that initial Dockerfile to see why we had two copy instructions.</p> <div class="saber-highlight" data-lang="sh"><pre class="saber-highlight-code language-sh"><code class="language-sh">FROM node:10.7.0-alpine

WORKDIR /usr/src/app

COPY package*.json /usr/src/app/

RUN npm install &amp;&amp; \
    npm cache clean -f

COPY . .

CMD [&quot;/bin/bash&quot;, &quot;/usr/src/app/init&quot;]</code></pre></div><p>For nodejs, package.json references the dependencies you want to install, and similarly, package-lock.json is metadata referring to the locked down dependency tree of what was previously installed. So above, package-lock.json would get a hash, if it changes we would run npm install from scratch and any instructions after that. If package-lock.json is the same as before, matching the cache, then we would use the cache and be eligible to use the cache for any instruction after that. <em>This means we can avoid a fresh npm install for every build by using the cache and saving on build time.</em></p> <h3 id="deploy-time">Deploy time</h3> <p>Once we’ve built an image, we can push it to some central store like dockerhub to retrieve later. What we are really storing is each image layer and metadata on what image layers make up a complete image. This is nice as when we are deploying software and pulling in each layer, we can first check the file system to see if each layer is cached. Usually, you just bring in the top most layer which has a small change set. Here is an example of what you would see when inspecting the image.</p> <blockquote><p>$ docker inspect node:latest</p></blockquote> <div class="saber-highlight" data-lang="sh"><pre class="saber-highlight-code language-sh"><code class="language-sh">&quot;RootFS&quot;: {
  &quot;Type&quot;: &quot;layers&quot;,
  &quot;Layers&quot;: [
    &quot;sha256:73046094a9b835e443af1a9d736fcfc11a994107500e474d0abf399499ed280c&quot;,
    &quot;sha256:1f9f6c582bc2d0f7e70f6745e27d8e80b900cbb2cd1768b44021eb504f72d7de&quot;,
    &quot;sha256:0226750bc9fd9c86156d27378d9f243ffda55512222165b67c8595ea38490e13&quot;,
    &quot;sha256:31185621b9371561bb88ada0f5347ba85fc544cfc1c9417dccab790ddc64772b&quot;,
    &quot;sha256:e3357a4f00789a8203cfd07e51e77c691fdee07bb96e4bb1ce439b7ae9e77268&quot;,
    &quot;sha256:65b7d452c10466fe20133578e44d32cc4aa7b5daf5776b90765706579968e131&quot;,
    &quot;sha256:eac0035b5697e7a158849af0a08b4feb073d22319a6263c9219f1e13b36a8e45&quot;
  ]
}</code></pre></div><h2 id="keep-it-light">Keep it light</h2> <p>As you can see, Docker images are the files, aka the blueprint, that your containers start from. It is often easy to add an OS flavor of your liking and use the built-in package manager to add whatever you need. But, be careful, as building and deploying these images can grow over time. And, if you start out with a large image, you’ll only continue to pay down the road as build and deploy times start to grow. Let’s take a quick look at a couple popular base image choices:</p> <ul><li><em>CentOS</em> — 200 mb</li> <li><em>Ubuntu</em> — 115 mb</li> <li><em>Alpine</em> — 5 mb</li></ul> <p>Alpine is based off of musl libc with a trimmed down set of binaries out of the box to keep it small. It also comes with it’s own apk package manager. This is a great choice for a base image.</p> <h2 id="conclusion">Conclusion</h2> <p>Understanding docker images and it’s corresponding layers is important. Optimize how you construct each layer to save you time during builds as well as deploys. Be sure to look at the output of your images history and see if there are any heavy layers that need updates.</p> <p>For further reading, checkout:</p> <ul><li><a rel="noopener noreferrer" target="_blank" href="https://docs.docker.com/v17.09/engine/userguide/storagedriver/imagesandcontainers/">https://docs.docker.com/v17.09/engine/userguide/storagedriver/imagesandcontainers/</a></li> <li><a rel="noopener noreferrer" target="_blank" href="https://docs.docker.com/v17.09/engine/userguide/eng-image/dockerfile_best-practices">https://docs.docker.com/v17.09/engine/userguide/eng-image/dockerfile_best-practices</a></li></ul></div> <!----> <a href="/posts/understanding-docker-images.html" hidden="hidden" class="u-url router-link-exact-active router-link-active"></a></article></div></main> <footer class="site-footer h-card"><div class="wrapper"><div class="footer-col-wrapper"><div class="footer-col one-half"><h2 class="footer-heading">Shaun Warman</h2> <ul class="contact-list"><li class="p-name">Shaun Warman</li> <li><a href="mailto:shaunwarman1@gmail.com" class="u-email">shaunwarman1@gmail.com</a></li></ul></div> <div class="footer-col one-half"><p>Heads down</p></div> <div class="social-links"><ul class="social-media-list"><!----> <!----> <!----> <li><a title="shaunwarman" rel="noopener noreferrer" target="_blank" href="https://github.com/shaunwarman"><svg class="svg-icon grey"><use xlink:href="/_saber/images/minima-social-icons.198a7e12.svg#github"></use></svg></a></li> <!----> <li><a title="shaunwarman" rel="noopener noreferrer" target="_blank" href="https://www.linkedin.com/in/shaunwarman"><svg class="svg-icon grey"><use xlink:href="/_saber/images/minima-social-icons.198a7e12.svg#linkedin"></use></svg></a></li> <!----> <!----> <!----> <!----> <!----> <!----> <!----></ul></div></div></div></footer></div></div><script src="/_saber/js/client.eb8685cc.js" defer></script><script src="/_saber/js/page--_posts-2018-06-26-understanding-docker-images-md.e5714201.js" defer></script></body></html>
